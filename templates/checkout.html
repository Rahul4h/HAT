{% extends 'base.html' %}
{% block title %}Checkout{% endblock %}
{% block body %}
<div class="container py-5">
    <h3>üõçÔ∏è Checkout</h3>

    <form method="POST" id="checkout-form">
        {% csrf_token %}
        <div class="row mt-4">
            <!-- Shipping Form -->
            <div class="col-md-6">
                <h5>Enter Your Shipping Address</h5>
                <div class="border p-3 rounded mb-3">
                    {{ form.as_p }}
                </div>

                <!-- ‚úÖ Payment Method Selection -->
                <h5>Select Payment Method</h5>
                <div class="border p-3 rounded">
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="payment_method" id="stripe" value="stripe" required>
                        <label class="form-check-label" for="stripe">üí≥ Pay with Stripe</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="payment_method" id="cod" value="cod" required>
                        <label class="form-check-label" for="cod">Cash on Delivery</label>
                    </div>
                </div>

                <input type="hidden" name="product_id" value="{{ product.id }}">
                <label for="quantity"><strong>Quantity:</strong></label>
                <input 
                 type="number" 
                 name="quantity" 
                 id="quantity"
                 value="{{ quantity }}" 
                 min="1" 
                 max="{{ product.stock }}" 
                 class="form-control mb-3" 
                 required
               >
               <small class="text-muted">Only {{ product.stock }} left in stock.</small>

                <input type="hidden" name="amount" value="{{ total }}">

                <button type="submit" class="btn btn-success mt-3" id="proceedBtn">Proceed to Order</button>
            </div>

            <!-- Order Summary -->
            <div class="col-md-6">
                <h5>Order Summary</h5>
                <div class="border p-3 rounded">
                    <img src="{{ product.image.url }}" alt="{{ product.title }}" style="height: 100px;">
                    <p><strong>{{ product.title }}</strong></p>
                    <p>
                       ‡ß≥<span id="unit-price">{{ product.sale_price }}</span> √ó 
                       <span id="display-quantity">{{ quantity }}</span>
                   </p>
                   <hr>
                   <p>Subtotal: ‡ß≥<span id="subtotal">{{ subtotal }}</span></p>
                   <p>Delivery Fee: ‡ß≥<span id="delivery">{{ delivery_fee }}</span></p>
                   <h5>Total: ‡ß≥<span id="total">{{ total }}</span></h5>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- üîÅ Script to handle redirect for Stripe -->
<script>
document.getElementById('checkout-form').addEventListener('submit', function(e) {
    const selectedMethod = document.querySelector('input[name="payment_method"]:checked').value;

    if (selectedMethod === 'stripe') {
        e.preventDefault(); // stop normal form submission

        const form = e.target;
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        fetch("{% url 'checkout' product.id %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': csrfToken
            },
            body: new URLSearchParams(new FormData(form))
        })
        .then(res => res.json())
        .then(data => {
            if (data.session_url) {
                window.location.href = data.session_url;
            } else {
                alert("Something went wrong. Try again.");
            }
        })
        .catch(err => {
            console.error("Payment error:", err);
            alert("Payment failed.");
        });
    }
});
document.addEventListener('DOMContentLoaded', function () {
    const quantityInput = document.getElementById('quantity');
    const unitPrice = parseFloat(document.getElementById('unit-price').textContent);
    const deliveryFee = parseFloat(document.getElementById('delivery').textContent);

    quantityInput.addEventListener('input', function () {
        const qty = parseInt(quantityInput.value) || 1;
        const subtotal = unitPrice * qty;
        const total = subtotal + deliveryFee;

        document.getElementById('display-quantity').textContent = qty;
        document.getElementById('subtotal').textContent = subtotal.toFixed(2);
        document.getElementById('total').textContent = total.toFixed(2);

        document.querySelector('input[name="amount"]').value = total.toFixed(2);
    });
});
</script>
{% endblock %}
